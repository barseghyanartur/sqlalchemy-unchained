
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono:400,500,700&display=fallback">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="_static/javascripts/modernizr.js"></script>
  
  
  
    <title>Introducing SQLAlchemy Unchained &#8212; SQLAlchemy Unchained v0.9.1 documentation</title>
    <link rel="stylesheet" href="_static/material.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Documentation" href="api.html" />
    <link rel="prev" title="Table of Contents" href="table-of-contents.html" />
  
   
  
  <script src="_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = ""versions.json"",
        target_loc = "../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>


  </head>
  <body dir=ltr
        data-md-color-primary=blue data-md-color-accent=light-blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#index" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="/" title="SQLAlchemy Unchained v0.9.1 documentation" class="md-header-nav__button md-logo">
          
            <i class="md-icon">&#8734</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">
            <a href="/" title="SQLAlchemy Unchained v0.9.1 documentation">SQLAlchemy Unchained</a>
          </span>
          <span class="md-header-nav__topic">
            <a href="" title="Introducing SQLAlchemy Unchained">
              Introducing SQLAlchemy Unchained
            </a>
          </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="search.html" method="GET" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/briancappello/sqlalchemy-unchained" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    SQLAlchemy Unchained
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>

  
  <div class="md-container">
    
  
  <div class="md-hero"
       data-md-component="hero"
  >
    <div class="md-hero__inner md-grid">
      <p>Enhanced declarative models for SQLAlchemy</p>
    </div>
  </div>

    
    
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="table-of-contents.html" title="SQLAlchemy Unchained v0.9.1 documentation" class="md-nav__button md-logo">
      
        <i class="md-icon">&#8734</i>
      
    </a>
    <a href="table-of-contents.html"
       title="SQLAlchemy Unchained v0.9.1 documentation">SQLAlchemy Unchained</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/briancappello/sqlalchemy-unchained" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    SQLAlchemy Unchained
  </div>
</a>
    </div>
  
  


  

  

  <ul class="md-nav__list">
    <li class="md-nav__item">
      
        <input type="checkbox" id="__toc"
               class="md-toggle md-nav__toggle"
               data-md-toggle="toc">
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Introducing SQLAlchemy Unchained
        </label>
      

      <a href="#"
         class="md-nav__link md-nav__link--active"
      >
        Introducing SQLAlchemy Unchained
      </a>

      
        

<nav class="md-nav md-nav--secondary">
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item">
          <a href="#index--page-root" class="md-nav__link">
            
              <strong>Introducing SQLAlchemy Unchained</strong>
            
          </a><nav class="md-nav">
              <ul class="md-nav__list">
                
        <li class="md-nav__item">
          <a href="#useful-links" class="md-nav__link">
            
              Useful Links
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#usage" class="md-nav__link">
            
              Usage
            
          </a><nav class="md-nav">
              <ul class="md-nav__list">
                
        <li class="md-nav__item">
          <a href="#installation" class="md-nav__link">
            
              Installation
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#configure" class="md-nav__link">
            
              Configure
            
          </a><nav class="md-nav">
              <ul class="md-nav__list">
                
        <li class="md-nav__item">
          <a href="#using-sqlite" class="md-nav__link">
            
              Using SQLite
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#using-postgresql-or-mariadb-mysql" class="md-nav__link">
            
              Using PostgreSQL or MariaDB/MySQL
            
          </a>
        </li>
              </ul>
            </nav>
        </li>
        <li class="md-nav__item">
          <a href="#connect" class="md-nav__link">
            
              Connect
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#create-some-models" class="md-nav__link">
            
              Create some models
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#configure-database-migrations" class="md-nav__link">
            
              Configure database migrations
            
          </a>
        </li>
              </ul>
            </nav>
        </li>
        <li class="md-nav__item">
          <a href="#using-sessionmanager-and-model-managers" class="md-nav__link">
            
              Using SessionManager and Model Managers
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#included-meta-options" class="md-nav__link">
            
              Included Meta Options
            
          </a><nav class="md-nav">
              <ul class="md-nav__list">
                
        <li class="md-nav__item">
          <a href="#table-tablename" class="md-nav__link">
            
              table (<code class="docutils literal notranslate"><span class="pre">__tablename__</span></code>)
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#pk-primary-key-column" class="md-nav__link">
            
              pk (primary key column)
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#created-at-row-insertion-timestamp" class="md-nav__link">
            
              created_at (row insertion timestamp)
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#updated-at-last-updated-timestamp" class="md-nav__link">
            
              updated_at (last updated timestamp)
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#repr-automatic-pretty-repr" class="md-nav__link">
            
              repr (automatic pretty <code class="docutils literal notranslate"><span class="pre">__repr__</span></code>)
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#validation" class="md-nav__link">
            
              validation
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#polymorphic-mapped-model-class-hierarchies" class="md-nav__link">
            
              polymorphic (mapped model class hierarchies)
            
          </a>
        </li>
              </ul>
            </nav>
        </li>
        <li class="md-nav__item">
          <a href="#model-validation" class="md-nav__link">
            
              Model Validation
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#customizing-meta-options" class="md-nav__link">
            
              Customizing Meta Options
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#customizing-the-default-primary-key-column-name" class="md-nav__link">
            
              Customizing the Default Primary Key Column Name
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#lazy-mapping-experimental" class="md-nav__link">
            
              Lazy Mapping (experimental)
            
          </a>
        </li>
              </ul>
            </nav>
        </li>
      
<li class="md-nav__item"><a class="md-nav__extra_link" href="_sources/index.rst.txt">Show Source</a> </li>

  </ul>
</nav>
      <ul class="md-nav__list">
          
    <li class="md-nav__item">
      

      <a href="#useful-links"
         class="md-nav__link"
      >
        Useful Links
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#usage"
         class="md-nav__link"
      >
        Usage
      </a>

      <ul class="md-nav__list">
          
    <li class="md-nav__item">
      

      <a href="#installation"
         class="md-nav__link"
      >
        Installation
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#configure"
         class="md-nav__link"
      >
        Configure
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#connect"
         class="md-nav__link"
      >
        Connect
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#create-some-models"
         class="md-nav__link"
      >
        Create some models
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#configure-database-migrations"
         class="md-nav__link"
      >
        Configure database migrations
      </a>

      
    </li>
        </ul>
    </li>
    <li class="md-nav__item">
      

      <a href="#using-sessionmanager-and-model-managers"
         class="md-nav__link"
      >
        Using SessionManager and Model Managers
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#included-meta-options"
         class="md-nav__link"
      >
        Included Meta Options
      </a>

      <ul class="md-nav__list">
          
    <li class="md-nav__item">
      

      <a href="#table-tablename"
         class="md-nav__link"
      >
        table (<code class="docutils literal notranslate"><span class="pre">__tablename__</span></code>)
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#pk-primary-key-column"
         class="md-nav__link"
      >
        pk (primary key column)
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#created-at-row-insertion-timestamp"
         class="md-nav__link"
      >
        created_at (row insertion timestamp)
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#updated-at-last-updated-timestamp"
         class="md-nav__link"
      >
        updated_at (last updated timestamp)
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#repr-automatic-pretty-repr"
         class="md-nav__link"
      >
        repr (automatic pretty <code class="docutils literal notranslate"><span class="pre">__repr__</span></code>)
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#validation"
         class="md-nav__link"
      >
        validation
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#polymorphic-mapped-model-class-hierarchies"
         class="md-nav__link"
      >
        polymorphic (mapped model class hierarchies)
      </a>

      
    </li>
        </ul>
    </li>
    <li class="md-nav__item">
      

      <a href="#model-validation"
         class="md-nav__link"
      >
        Model Validation
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#customizing-meta-options"
         class="md-nav__link"
      >
        Customizing Meta Options
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#customizing-the-default-primary-key-column-name"
         class="md-nav__link"
      >
        Customizing the Default Primary Key Column Name
      </a>

      
    </li>
    <li class="md-nav__item">
      

      <a href="#lazy-mapping-experimental"
         class="md-nav__link"
      >
        Lazy Mapping (experimental)
      </a>

      
    </li>
        </ul>
    </li>
    <li class="md-nav__item">
      

      <a href="api.html"
         class="md-nav__link"
      >
        API Documentation
      </a>

      
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                

<nav class="md-nav md-nav--secondary">
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item">
          <a href="#index--page-root" class="md-nav__link">
            
              <strong>Introducing SQLAlchemy Unchained</strong>
            
          </a><nav class="md-nav">
              <ul class="md-nav__list">
                
        <li class="md-nav__item">
          <a href="#useful-links" class="md-nav__link">
            
              Useful Links
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#usage" class="md-nav__link">
            
              Usage
            
          </a><nav class="md-nav">
              <ul class="md-nav__list">
                
        <li class="md-nav__item">
          <a href="#installation" class="md-nav__link">
            
              Installation
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#configure" class="md-nav__link">
            
              Configure
            
          </a><nav class="md-nav">
              <ul class="md-nav__list">
                
        <li class="md-nav__item">
          <a href="#using-sqlite" class="md-nav__link">
            
              Using SQLite
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#using-postgresql-or-mariadb-mysql" class="md-nav__link">
            
              Using PostgreSQL or MariaDB/MySQL
            
          </a>
        </li>
              </ul>
            </nav>
        </li>
        <li class="md-nav__item">
          <a href="#connect" class="md-nav__link">
            
              Connect
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#create-some-models" class="md-nav__link">
            
              Create some models
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#configure-database-migrations" class="md-nav__link">
            
              Configure database migrations
            
          </a>
        </li>
              </ul>
            </nav>
        </li>
        <li class="md-nav__item">
          <a href="#using-sessionmanager-and-model-managers" class="md-nav__link">
            
              Using SessionManager and Model Managers
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#included-meta-options" class="md-nav__link">
            
              Included Meta Options
            
          </a><nav class="md-nav">
              <ul class="md-nav__list">
                
        <li class="md-nav__item">
          <a href="#table-tablename" class="md-nav__link">
            
              table (<code class="docutils literal notranslate"><span class="pre">__tablename__</span></code>)
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#pk-primary-key-column" class="md-nav__link">
            
              pk (primary key column)
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#created-at-row-insertion-timestamp" class="md-nav__link">
            
              created_at (row insertion timestamp)
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#updated-at-last-updated-timestamp" class="md-nav__link">
            
              updated_at (last updated timestamp)
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#repr-automatic-pretty-repr" class="md-nav__link">
            
              repr (automatic pretty <code class="docutils literal notranslate"><span class="pre">__repr__</span></code>)
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#validation" class="md-nav__link">
            
              validation
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#polymorphic-mapped-model-class-hierarchies" class="md-nav__link">
            
              polymorphic (mapped model class hierarchies)
            
          </a>
        </li>
              </ul>
            </nav>
        </li>
        <li class="md-nav__item">
          <a href="#model-validation" class="md-nav__link">
            
              Model Validation
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#customizing-meta-options" class="md-nav__link">
            
              Customizing Meta Options
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#customizing-the-default-primary-key-column-name" class="md-nav__link">
            
              Customizing the Default Primary Key Column Name
            
          </a>
        </li>
        <li class="md-nav__item">
          <a href="#lazy-mapping-experimental" class="md-nav__link">
            
              Lazy Mapping (experimental)
            
          </a>
        </li>
              </ul>
            </nav>
        </li>
      
<li class="md-nav__item"><a class="md-nav__extra_link" href="_sources/index.rst.txt">Show Source</a> </li>

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  
<h1 id="index--page-root">Introducing SQLAlchemy Unchained<a class="headerlink" href="#index--page-root" title="Permalink to this headline">¶</a></h1>
<p>Enhanced declarative models for SQLAlchemy.</p>

<h2 id="useful-links">Useful Links<a class="headerlink" href="#useful-links" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io">Read the Docs</a></p></li>
<li><p><a class="reference external" href="https://github.com/briancappello/sqlalchemy-unchained">GitHub</a></p></li>
<li><p><a class="reference external" href="https://pypi.org/project/SQLAlchemy-Unchained/">PyPI</a></p></li>
</ul>


<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>

<h3 id="installation">Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h3>
<p>Requires Python 3.6+, SQLAlchemy and Alembic (for migrations)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install sqlalchemy-unchained
</pre></div>
</div>
<p>First let’s create a directory structure to work with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir your-project <span class="o">&amp;&amp;</span> <span class="nb">cd</span> your-project <span class="o">&amp;&amp;</span> <span class="se">\</span>
mkdir your_package <span class="o">&amp;&amp;</span> mkdir db <span class="o">&amp;&amp;</span> <span class="se">\</span>
touch setup.py your_package/config.py your_package/db.py your_package/models.py
</pre></div>
</div>
<p>From now it is assumed that you are working from the <code class="docutils literal notranslate"><span class="pre">your-project</span></code> directory. All file paths at the top of code samples will be relative to this directory, and all commands should be run from this directory (unless otherwise noted).</p>


<h3 id="configure">Configure<a class="headerlink" href="#configure" title="Permalink to this headline">¶</a></h3>

<h4 id="using-sqlite">Using SQLite<a class="headerlink" href="#using-sqlite" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># your_package/config.py</span>

<span class="kn">import</span> <span class="nn">os</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
    <span class="n">PROJECT_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>

    <span class="n">DATABASE_URI</span> <span class="o">=</span> <span class="s1">'sqlite:///'</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="s1">'db'</span><span class="p">,</span> <span class="s1">'dev.sqlite'</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we’re creating an on-disk SQLite database at <code class="docutils literal notranslate"><span class="pre">project-root/db/dev.sqlite</span></code>.</p>


<h4 id="using-postgresql-or-mariadb-mysql">Using PostgreSQL or MariaDB/MySQL<a class="headerlink" href="#using-postgresql-or-mariadb-mysql" title="Permalink to this headline">¶</a></h4>
<p>If instead you’d like to use PostgreSQL or MariaDB/MySQL, now would be the time to configure it. For example, to use PostgreSQL with the <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code> engine:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># your_package/config.py</span>

<span class="kn">import</span> <span class="nn">os</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
    <span class="n">DATABASE_URI</span> <span class="o">=</span> <span class="s1">'{engine}://{user}:{pw}@{host}:{port}/{db}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">engine</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'SQLALCHEMY_DATABASE_ENGINE'</span><span class="p">,</span> <span class="s1">'postgresql+psycopg2'</span><span class="p">),</span>
        <span class="n">user</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'SQLALCHEMY_DATABASE_USER'</span><span class="p">,</span> <span class="s1">'your_db_user'</span><span class="p">),</span>
        <span class="n">pw</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'SQLALCHEMY_DATABASE_PASSWORD'</span><span class="p">,</span> <span class="s1">'your_db_user_password'</span><span class="p">),</span>
        <span class="n">host</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'SQLALCHEMY_DATABASE_HOST'</span><span class="p">,</span> <span class="s1">'127.0.0.1'</span><span class="p">),</span>
        <span class="n">port</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'SQLALCHEMY_DATABASE_PORT'</span><span class="p">,</span> <span class="mi">5432</span><span class="p">),</span>
        <span class="n">db</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'SQLALCHEMY_DATABASE_NAME'</span><span class="p">,</span> <span class="s1">'your_db_name'</span><span class="p">))</span>
</pre></div>
</div>
<p>For MariaDB/MySQL, replace the <code class="docutils literal notranslate"><span class="pre">engine</span></code> parameter with <code class="docutils literal notranslate"><span class="pre">mysql+mysqldb</span></code> and the <code class="docutils literal notranslate"><span class="pre">port</span></code> parameter with <code class="docutils literal notranslate"><span class="pre">3306</span></code>.</p>
<p>Note that you’ll probably need to install the relevant driver package, eg:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># for postgresql+psycopg2</span>
pip install psycopg2-binary

<span class="c1"># for mysql+mysqldb</span>
pip install mysqlclient
</pre></div>
</div>
<p>See the official documentation on <a class="reference external" href="https://docs.sqlalchemy.org/en/latest/dialects/">SQLAlchemy Dialects</a> to learn more about connecting to other database engines.</p>



<h3 id="connect">Connect<a class="headerlink" href="#connect" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># your_package/db.py</span>

<span class="kn">from</span> <span class="nn">sqlalchemy_unchained</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">Config</span>


<span class="n">engine</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">relationship</span> <span class="o">=</span> <span class="n">init_sqlalchemy_unchained</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">DATABASE_URI</span><span class="p">)</span>
</pre></div>
</div>
<p>If you need to customize the creation of any of these parameters, this is what <code class="docutils literal notranslate"><span class="pre">init_sqlalchemy_unchained</span></code> is doing behind the scenes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># your_package/db.py</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span> <span class="k">as</span> <span class="n">_relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy_unchained</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sqlalchemy_unchained</span> <span class="kn">import</span> <span class="n">_wrap_with_default_query_class</span>

<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">Config</span>


<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">DATABASE_URI</span><span class="p">)</span>
<span class="n">Session</span> <span class="o">=</span> <span class="n">scoped_session_factory</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">query_cls</span><span class="o">=</span><span class="n">BaseQuery</span><span class="p">)</span>
<span class="n">SessionManager</span><span class="o">.</span><span class="n">set_session_factory</span><span class="p">(</span><span class="n">Session</span><span class="p">)</span>
<span class="n">Model</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">relationship</span> <span class="o">=</span> <span class="n">_wrap_with_default_query_class</span><span class="p">(</span><span class="n">_relationship</span><span class="p">,</span> <span class="n">BaseQuery</span><span class="p">)</span>
</pre></div>
</div>


<h3 id="create-some-models">Create some models<a class="headerlink" href="#create-some-models" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># your_package/models.py</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">db</span>


<span class="k">class</span> <span class="nc">Parent</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">children</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">'Child'</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s1">'parent'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">foreign_key</span><span class="p">(</span><span class="s1">'Parent'</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">'Parent'</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s1">'children'</span><span class="p">)</span>
</pre></div>
</div>
<p>This is the first bit that’s really different from using stock SQLAlchemy. By default, models in SQLAlchemy Unchained automatically have their <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> set to the snake_cased model class name, and include a primary key column <code class="docutils literal notranslate"><span class="pre">id</span></code> as well as the automatically-timestamped columns <code class="docutils literal notranslate"><span class="pre">created_at</span></code> and <code class="docutils literal notranslate"><span class="pre">updated_at</span></code>.</p>
<p>This is customizable. For example, if you wanted to rename the columns on <code class="docutils literal notranslate"><span class="pre">Parent</span></code>, and disable timestamping on <code class="docutils literal notranslate"><span class="pre">Child</span></code> and rename its table name to <code class="docutils literal notranslate"><span class="pre">children</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># your_package/models.py</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">db</span>


<span class="k">class</span> <span class="nc">Parent</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="s1">'pk'</span>
        <span class="n">created_at</span> <span class="o">=</span> <span class="s1">'created'</span>
        <span class="n">updated_at</span> <span class="o">=</span> <span class="s1">'updated'</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">children</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">'Child'</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s1">'parent'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">'children'</span>
        <span class="n">created_at</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">updated_at</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">foreign_key</span><span class="p">(</span><span class="s1">'Parent'</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">'Parent'</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s1">'children'</span><span class="p">)</span>
</pre></div>
</div>
<p>The are other <code class="docutils literal notranslate"><span class="pre">Meta</span></code> options that SQLAlchemy Unchained supports, and we’ll have a look at those in a bit. We’ll also cover how to change the defaults for all models, as well as how to add support for your own custom <code class="docutils literal notranslate"><span class="pre">Meta</span></code> options. But for now, let’s get migrations configured before we continue any further.</p>


<h3 id="configure-database-migrations">Configure database migrations<a class="headerlink" href="#configure-database-migrations" title="Permalink to this headline">¶</a></h3>
<p>Initialize Alembic:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>alembic init db/migrations
</pre></div>
</div>
<p>Next, we need to configure Alembic to use the same database as we’ve already configured. This happens towards the top of the <code class="docutils literal notranslate"><span class="pre">db/migrations/env.py</span></code> file, which the <code class="docutils literal notranslate"><span class="pre">alembic</span> <span class="pre">init</span></code> command generated for us. Modify the following lines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">your_package.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">your_package.db</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">your_package.models</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>For these import statements to work, we need to install our package. Let’s create a minimal <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># setup.py</span>

<span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>


<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">'your-project'</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s1">'0.1.0'</span><span class="p">,</span>
    <span class="n">packages</span><span class="o">=</span><span class="n">find_packages</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">'docs'</span><span class="p">,</span> <span class="s1">'tests'</span><span class="p">]),</span>
    <span class="n">include_package_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">zip_safe</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">'sqlalchemy-unchained==0.9.1'</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<p>And install the package into the virtual environment you’re using for development:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install -e .
</pre></div>
</div>
<p>That should be all that’s required to get migrations working. Let’s generate a migration for our models and run it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>alembic revision --autogenerate -m <span class="s1">'create models'</span>
<span class="c1"># verify the generated migration is going to do what you want, and then run it:</span>
alembic upgrade head
</pre></div>
</div>



<h2 id="using-sessionmanager-and-model-managers">Using SessionManager and Model Managers<a class="headerlink" href="#using-sessionmanager-and-model-managers" title="Permalink to this headline">¶</a></h2>
<p>SQLAlchemy Unchained encourages embracing the design patterns recommended by the Data Mapper Pattern that SQLAlchemy uses. This means we use managers (or services, if you prefer) to handle all of our interactions with the database. SQLAlchemy Unchained includes two classes to facilitate making this as easy as possible: <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#sessionmanager">SessionManager</a> and <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#modelmanager">ModelManager</a>.</p>
<p><a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#sessionmanager">SessionManager</a> is a concrete class that you can and should use directly whenever you need to interact with the database session. <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#modelmanager">ModelManager</a> is an abstract subclass of <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#sessionmanager">SessionManager</a> that you should extend for each of the models in your application:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">your_package</span> <span class="kn">import</span> <span class="n">db</span>


<span class="k">class</span> <span class="nc">YourModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">YourModelManager</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">ModelManager</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">YourModel</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YourModel</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="n">commit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">YourModel</span><span class="p">,</span> <span class="bp">None</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>


<span class="n">instance</span> <span class="o">=</span> <span class="n">YourModelManager</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'foobar'</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Both <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#sessionmanager">SessionManager</a> and <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#modelmanager">ModelManager</a> are singletons, so whenever you call <code class="docutils literal notranslate"><span class="pre">SessionManager()</span></code> or <code class="docutils literal notranslate"><span class="pre">YourModelManager()</span></code>, you will always get the same instance.</p>


<h2 id="included-meta-options">Included Meta Options<a class="headerlink" href="#included-meta-options" title="Permalink to this headline">¶</a></h2>

<h3 id="table-tablename">table (<code class="docutils literal notranslate"><span class="pre">__tablename__</span></code>)<a class="headerlink" href="#table-tablename" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'foo'</span>
</pre></div>
</div>
<p>Set to customize the name of the table in the database for the model. By default, we use the model’s class name converted to snake case.</p>
<p>NOTE: The snake case logic used is slightly different from that of Flask-SQLAlchemy, so if you’re porting your models over and any of them have sequential upper-case letters, you will probably need to change the default.</p>


<h3 id="pk-primary-key-column">pk (primary key column)<a class="headerlink" href="#pk-primary-key-column" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">pk</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ModelRegistry</span><span class="p">()</span><span class="o">.</span><span class="n">default_primary_key_column</span> <span class="o">=</span> <span class="s1">'id'</span>
</pre></div>
</div>
<p>Set to a string to customize the column name used for the primary key, or set to <code class="docutils literal notranslate"><span class="pre">None</span></code> to disable the column.</p>
<p>NOTE: Customizing the default primary key column name used for all models is different from customizing the defaults for other meta options. (You should subclass <code class="docutils literal notranslate"><span class="pre">_ModelRegistry</span></code> and set its <code class="docutils literal notranslate"><span class="pre">default_primary_key_column</span></code> attribute. This is necessary for the <code class="docutils literal notranslate"><span class="pre">foreign_key</span></code> helper function to work correctly.)</p>


<h3 id="created-at-row-insertion-timestamp">created_at (row insertion timestamp)<a class="headerlink" href="#created-at-row-insertion-timestamp" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">created_at</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'created_at'</span>  <span class="c1"># 'created_at' is the default</span>
</pre></div>
</div>
<p>Set to a string to customize the column name used for the creation timestamp, or set to <code class="docutils literal notranslate"><span class="pre">None</span></code> to disable the column.</p>


<h3 id="updated-at-last-updated-timestamp">updated_at (last updated timestamp)<a class="headerlink" href="#updated-at-last-updated-timestamp" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">updated_at</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'updated_at'</span>  <span class="c1"># 'updated_at' is the default</span>
</pre></div>
</div>
<p>Set to a string to customize the column name used for the updated timestamp, or set to <code class="docutils literal notranslate"><span class="pre">None</span></code> to disable the column.</p>


<h3 id="repr-automatic-pretty-repr">repr (automatic pretty <code class="docutils literal notranslate"><span class="pre">__repr__</span></code>)<a class="headerlink" href="#repr-automatic-pretty-repr" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="nb">repr</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_ModelRegistry</span><span class="o">.</span><span class="n">default_primary_key_column</span><span class="p">,)</span> <span class="c1"># default is ('id',)</span>

<span class="k">print</span><span class="p">(</span><span class="n">Foo</span><span class="p">())</span>  <span class="c1"># prints: Foo(id=1)</span>
</pre></div>
</div>
<p>Set to a tuple of column (attribute) names to customize the representation of models.</p>


<h3 id="validation">validation<a class="headerlink" href="#validation" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">validation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># True is the default</span>
</pre></div>
</div>
<p>Set to <code class="docutils literal notranslate"><span class="pre">False</span></code> to disable validation of model instances.</p>


<h3 id="polymorphic-mapped-model-class-hierarchies">polymorphic (mapped model class hierarchies)<a class="headerlink" href="#polymorphic-mapped-model-class-hierarchies" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">polymorphic</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># None is the default</span>


<span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="n">Foo</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>This meta option is disabled by default, and can be set to one of <code class="docutils literal notranslate"><span class="pre">'joined'</span></code>, <code class="docutils literal notranslate"><span class="pre">'single'</span></code>, or <code class="docutils literal notranslate"><span class="pre">True</span></code> (an alias for <code class="docutils literal notranslate"><span class="pre">'joined'</span></code>). See <a class="reference external" href="https://docs.sqlalchemy.org/en/latest/orm/inheritance.html">the SQLAlchemy documentation on class inheritance hierarchies</a> for more info.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">polymorphic</span></code> is enabled, there are two other meta options available to further customize its behavior:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">polymorphic</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">polymorphic_on</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'discriminator'</span>  <span class="c1"># column name to store polymorphic_identity in</span>
        <span class="n">polymorphic_identity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'models.Foo'</span>  <span class="c1"># unique identifier to use for this model</span>


<span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="n">Foo</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">polymorphic_identity</span> <span class="o">=</span> <span class="s1">'models.Bar'</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">polymorphic_identity</span></code> is the identifier used by SQLAlchemy to distinguish which model class a row should use, and defaults to using the model’s class name. The <code class="docutils literal notranslate"><span class="pre">polymorphic_identity</span></code> gets stored in the <code class="docutils literal notranslate"><span class="pre">polymorphic_on</span></code> column, which defaults to <code class="docutils literal notranslate"><span class="pre">'discriminator'</span></code>.</p>
<p><strong>IMPORTANT:</strong> The <code class="docutils literal notranslate"><span class="pre">polymorphic</span></code> and <code class="docutils literal notranslate"><span class="pre">polymorphic_on</span></code> Meta options should be specified on the base model of the hierarchy <em>only</em>. Conversely if you want to customize <code class="docutils literal notranslate"><span class="pre">polymorphic_identity</span></code>, it should be specified on <em>every</em> model in the hierarchy.</p>



<h2 id="model-validation">Model Validation<a class="headerlink" href="#model-validation" title="Permalink to this headline">¶</a></h2>
<p>SQLAlchemy Unchained adds support for validating models before persisting them to the database. This is enabled by default, although you can disable it with the <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/readme.html#validation">validation</a> Meta option.</p>
<p>There is one included validator: <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#required">Required</a>. It can be used like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">your_package</span> <span class="kn">import</span> <span class="n">db</span>


<span class="k">class</span> <span class="nc">YourModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="n">middle_name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="s1">'a custom message'</span><span class="p">))</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">Required</span><span class="p">]))</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s1">'a custom message'</span><span class="p">)]))</span>
</pre></div>
</div>
<p>There are two different ways you can write custom validation for your models.</p>
<p>The first is by extending <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#basevalidator">BaseValidator</a>, implementing <code class="docutils literal notranslate"><span class="pre">__call__</span></code>, and raising <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#validationerror">ValidationError</a> if the validation fails:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">your_package</span> <span class="kn">import</span> <span class="n">db</span>


<span class="k">class</span> <span class="nc">ValidateEmail</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">BaseValidator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'@'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>  <span class="c1"># not how you should actually verify email addresses</span>
            <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="ow">or</span> <span class="s1">'Invalid email address'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">YourModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">ValidateEmail</span><span class="p">]))</span>
</pre></div>
</div>
<p>The second is by defining a validation <code class="docutils literal notranslate"><span class="pre">classmethod</span></code> or <code class="docutils literal notranslate"><span class="pre">staticmethod</span></code> directly on the model class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">your_package</span> <span class="kn">import</span> <span class="n">db</span>


<span class="k">class</span> <span class="nc">YourModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">'@'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>  <span class="c1"># not how you should actually verify email addresses</span>
            <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s1">'Invalid email address'</span><span class="p">)</span>
</pre></div>
</div>
<p>Validation methods defined on model classes must follow a specific naming convention: either <code class="docutils literal notranslate"><span class="pre">validate_&lt;column_name&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">validates_&lt;column_name&gt;</span></code> will work. Just like when implementing <code class="docutils literal notranslate"><span class="pre">__call__</span></code> on <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#basevalidator">BaseValidator</a>, model validation methods should raise <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#validationerror">ValidationError</a> if their validation fails.</p>
<p>Validation happens automatically whenever your create or update a model instance. If any of the validators fail, <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#validationerrors">ValidationErrors</a> will be raised.</p>


<h2 id="customizing-meta-options">Customizing Meta Options<a class="headerlink" href="#customizing-meta-options" title="Permalink to this headline">¶</a></h2>
<p>The meta options available are configurable. Let’s take a look at the implementation of the <code class="docutils literal notranslate"><span class="pre">created_at</span></code> meta option:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="kn">as</span> <span class="nn">sa</span>

<span class="kn">from</span> <span class="nn">py_meta_utils</span> <span class="kn">import</span> <span class="n">McsArgs</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span> <span class="k">as</span> <span class="n">sa_func</span>
<span class="kn">from</span> <span class="nn">sqlalchemy_unchained</span> <span class="kn">import</span> <span class="n">ColumnMetaOption</span>


<span class="k">class</span> <span class="nc">CreatedAtColumnMetaOption</span><span class="p">(</span><span class="n">ColumnMetaOption</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'created_at'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">'created_at'</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="n">inherit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mcs_args</span><span class="p">:</span> <span class="n">McsArgs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">sa_func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</pre></div>
</div>
<p>For examples sake, let’s say you wanted every model to have a required name column, but no automatic timestamping behavior. First we need to implement a <a class="reference external" href="https://sqlalchemy-unchained.readthedocs.io/en/latest/api.html#columnmetaoption">ColumnMetaOption</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># your_package/base_model.py</span>

<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="kn">as</span> <span class="nn">sa</span>

<span class="kn">from</span> <span class="nn">py_meta_utils</span> <span class="kn">import</span> <span class="n">McsArgs</span>
<span class="kn">from</span> <span class="nn">sqlalchemy_unchained</span> <span class="kn">import</span> <span class="p">(</span><span class="n">BaseModel</span> <span class="k">as</span> <span class="n">_BaseModel</span><span class="p">,</span> <span class="n">ColumnMetaOption</span><span class="p">,</span>
                                  <span class="n">ModelMetaOptionsFactory</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NameColumnMetaOption</span><span class="p">(</span><span class="n">ColumnMetaOption</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">'name'</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mcs_args</span><span class="p">:</span> <span class="n">McsArgs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CustomModelMetaOptionsFactory</span><span class="p">(</span><span class="n">ModelMetaOptionsFactory</span><span class="p">):</span>
    <span class="n">_options</span> <span class="o">=</span> <span class="n">ModelMetaOptionsFactory</span><span class="o">.</span><span class="n">_options</span> <span class="o">+</span> <span class="p">[</span><span class="n">NameColumnMetaOption</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">_BaseModel</span><span class="p">):</span>
    <span class="n">_meta_options_factory_class</span> <span class="o">=</span> <span class="n">CustomModelMetaOptionsFactory</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">created_at</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">updated_at</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</div>
<p>The last step is to tell SQLAlchemy Unchained to use our customized <code class="docutils literal notranslate"><span class="pre">BaseModel</span></code> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># your_package/db.py</span>

<span class="kn">from</span> <span class="nn">sqlalchemy_unchained</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">.base_model</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">Config</span>


<span class="n">engine</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">relationship</span> <span class="o">=</span> <span class="n">init_sqlalchemy_unchained</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">DATABASE_URI</span><span class="p">,</span>
                                                                 <span class="n">model</span><span class="o">=</span><span class="n">BaseModel</span><span class="p">)</span>
</pre></div>
</div>


<h2 id="customizing-the-default-primary-key-column-name">Customizing the Default Primary Key Column Name<a class="headerlink" href="#customizing-the-default-primary-key-column-name" title="Permalink to this headline">¶</a></h2>
<p>The primary key column is special in that knowledge of its setting is required for determining foreign key column names during model class creation. The first step is to subclass the <code class="docutils literal notranslate"><span class="pre">_ModelRegistry</span></code> and set its <code class="docutils literal notranslate"><span class="pre">default_primary_key_column</span></code> class attribute:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># your_package/model_registry.py</span>

<span class="kn">from</span> <span class="nn">sqlalchemy_unchained</span> <span class="kn">import</span> <span class="n">_ModelRegistry</span> <span class="k">as</span> <span class="n">BaseModelRegistry</span>


<span class="k">class</span> <span class="nc">CustomModelRegistry</span><span class="p">(</span><span class="n">BaseModelRegistry</span><span class="p">):</span>
    <span class="n">default_primary_key_column</span> <span class="o">=</span> <span class="s1">'pk'</span>
</pre></div>
</div>
<p>And then, in order to inform SQLAlchemy Unchained about your customized model registry, you need call <code class="docutils literal notranslate"><span class="pre">_ModelRegistry.set_singleton_class</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># your_package/db.py</span>

<span class="kn">from</span> <span class="nn">sqlalchemy_unchained</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sqlalchemy_unchained</span> <span class="kn">import</span> <span class="n">_ModelRegistry</span>

<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">.model_registry</span> <span class="kn">import</span> <span class="n">CustomModelRegistry</span>


<span class="n">_ModelRegistry</span><span class="o">.</span><span class="n">set_singleton_class</span><span class="p">(</span><span class="n">CustomModelRegistry</span><span class="p">)</span>
<span class="n">engine</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">relationship</span> <span class="o">=</span> <span class="n">init_sqlalchemy_unchained</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">DATABASE_URI</span><span class="p">)</span>
</pre></div>
</div>


<h2 id="lazy-mapping-experimental">Lazy Mapping (experimental)<a class="headerlink" href="#lazy-mapping-experimental" title="Permalink to this headline">¶</a></h2>
<p>Lazy mapping is feature that this package introduces on top of SQLAlchemy. It’s experimental and disabled by default. In stock SQLAlchemy, when you define a model, the second that code gets imported, the base model’s metaclass will register the model with SQLAlchemy’s mapper. 99% of the time this is what you want to happen, but if for some reason you <em>don’t</em> want that behavior, then you have to enable lazy mapping. There are two components to enabling lazy mapping.</p>
<p>The first step is to customize the model registry:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># your_package/model_registry.py</span>

<span class="kn">from</span> <span class="nn">py_meta_utils</span> <span class="kn">import</span> <span class="n">McsInitArgs</span>
<span class="kn">from</span> <span class="nn">sqlalchemy_unchained</span> <span class="kn">import</span> <span class="n">_ModelRegistry</span>


<span class="k">class</span> <span class="nc">LazyModelRegistry</span><span class="p">(</span><span class="n">_ModelRegistry</span><span class="p">):</span>
    <span class="n">enable_lazy_mapping</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">should_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mcs_init_args</span><span class="p">:</span> <span class="n">McsInitArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">pass</span> <span class="c1"># implement your custom logic for determining which models to register</span>
        <span class="c1"># with SQLAlchemy</span>
</pre></div>
</div>
<p>And just like for customizing the primary key column, we need to inform <code class="docutils literal notranslate"><span class="pre">_ModelRegistry</span></code> of our subclass by calling <code class="docutils literal notranslate"><span class="pre">_ModelRegistry.set_singleton_class</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># your_package/db.py</span>

<span class="kn">from</span> <span class="nn">sqlalchemy_unchained</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sqlalchemy_unchained</span> <span class="kn">import</span> <span class="n">_ModelRegistry</span>

<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">.model_registry</span> <span class="kn">import</span> <span class="n">LazyModelRegistry</span>


<span class="n">_ModelRegistry</span><span class="o">.</span><span class="n">set_singleton_class</span><span class="p">(</span><span class="n">LazyModelRegistry</span><span class="p">)</span>
<span class="n">engine</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">relationship</span> <span class="o">=</span> <span class="n">init_sqlalchemy_unchained</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">DATABASE_URI</span><span class="p">)</span>
</pre></div>
</div>
<p>The last step is to define your models like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">lazy_mapped</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>




          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="table-of-contents.html" title="Material"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> Table of Contents </span>
              </div>
            </a>
          
          
            <a href="api.html" title="Admonition"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> API Documentation </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2018, Brian Cappello.
              
          </div>
            Created using
            <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>